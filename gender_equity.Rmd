---
title: "gener_equity"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(sf)
library(tidycensus)

library(magrittr)
library(arrow)

library(ggplot2)
library(glptools)
library(stringr)
#library(Hmisc)
```

#Skip
```{r prep_data, eval=FALSE}
census_data <- read_feather("../../glpdata/data-raw/microdata/acs_micro.feather")

census_data %<>%
  filter(FIPS == "21111")

write_feather(census_data, "raw_data/census_data.feather")

library(glpdata)

save(population_tract, file = "raw_data/tract_population.RData")

```

# Political Representation

## Metro Council

#Skip
```{r metro_council, eval = FALSE}
# metro_council <- read_csv("raw_data/Vati's work!!")
# 
# council_pct_female <- (metro_council$gender == "F") / 26
```

```{r state_legislature, eval=FALSE}

```

#Skip
```{r voter_registration, eval=FALSE}

# use readxl::read_excel to load the voter registration file

# use population_tract for population data

v20 <- load_variables(2020, "pl", cache = TRUE)

t=tidycensus::get_decennial("voting district", )

# combine data frames

```


# Housing data

In this first chunk, let's read in the Census microdata. Here is some example code on how to read in the data, create new variables to categorize the rows of data into groups, and then summarize the data to create information about Louisville.

Our goal is to create variables for gender, age group, whether someone is a mother, whether someone is married, their level of education, their income, whether they are the head of household, and the number of children they have.

#Skip
```{r read_and_classify}

# Load in census data
census_microdata <- read_feather("raw_data/census_data.feather")

# For age, need to categorize into groups, like this using case_when:
census_microdata %<>%
  mutate(
    age_group = case_when(
      age <= 18      ~ "0_18",
      age %in% 19:30 ~ "19_30"))

# To summarize the data, we can use the survey package, which will handle all of the weights for us
library(survey)

survey_object <- svydesign(id=~0, data = census_microdata, weights = ~PERWT)

output <- svyby(~age_group, ~sex+year, survey_object, svytotal, na.rm = TRUE)

# Or, we can summarize the data ourselves. I think this method is simpler.
output <- census_microdata %<>%
  group_by(year, sex, age_group) %>%
  summarize(number_of_people = sum(PERWT, na.rm = TRUE))


# Harrison will redownload the raw file so we can include more detailed information on race as well as the same-sex marriages
```


#Skip - only use if changing the ACS file
```{r read in new data, eval=FALSE}
acs_micro_8_11_22 <- read_feather("raw_data/acs_micro_FIPS_repwts_8_11_22.feather") 

acs_micro_8_11_22 %<>%
  filter(FIPS == "21111")


write_feather(acs_micro_8_11_22, "raw_data/census_data_8_11_22.feather")

```

#Start
```{r explore new data}
#File for use below
census_microdata081122 <- read_feather("raw_data/census_data_8_11_22.feather") 



```
This code chunk will identify which households are homeowners vs. renters (in the homeownership variable) and which households are cost-burdened, meaning they pay more thatn 30% of their income toward rent or a mortgage (in the cost_burden variable).

There are also variables for severe cost burden (households that pay more than half of their income towards housing) and households with severe housing problems (lacking a kitchen, adequate plumbing, or an ample number of rooms for the number of people living there).
```{r}
# To classify the housing data into homeowners, renters, cost-bu
#also create income brackets, earner types

census_microdata081122 %<>%
  group_by(year, SERIAL) %>%
  mutate(hh_members = n()) %>%
  ungroup() %>%
  filter(PERNUM == 1) %>%
  mutate(
    OWNCOST  = replace(OWNCOST, OWNCOST == 99999, NA),
    HHINCOME = replace(HHINCOME, HHINCOME == 99999, NA),
    OWNERSHP = replace(OWNERSHP, OWNERSHP == 0, NA),
    RENTGRS  = replace(RENTGRS, RENTGRS == 0 & OWNERSHP == 1, NA),

    homeownership = if_else(OWNERSHP == 1, T, F),

    hcost = if_else(homeownership == 1, OWNCOST, RENTGRS),
    cost_burden = if_else(hcost * 12 / HHINCOME > 0.3, T, F),
    severe_cost_burden = if_else(hcost * 12 / HHINCOME > 0.5, 1, 0),

    hh_type = case_when(
      homeownership  & !cost_burden ~ "noncb_homeowner",
      homeownership  & cost_burden  ~ "cb_homeowner",
      !homeownership & !cost_burden ~ "noncb_renter",
      !homeownership & cost_burden  ~ "cb_renter",
      TRUE ~ NA_character_),
    
    KITCHEN  = replace(KITCHEN, KITCHEN == 0, NA),
    ROOMS    = replace(ROOMS, ROOMS == 0, NA),
    PLUMBING = replace(PLUMBING, PLUMBING == 0, NA),

    severe_housing_problems = if_else(
      KITCHEN == 1 | PLUMBING == 10 | hh_members / ROOMS > 1 | severe_cost_burden, T, F),
    
#income brackets based on HHINCOME
  #LH-Lower half -> lower40% 
  #UH-Upper Half -> 40th to 80th 
  #T20 -> top 20th percentile

    
    income_group = case_when(
      HHINCOME <= quantile(HHINCOME, probs = 0.4) ~ 'LH',
      HHINCOME <= quantile(HHINCOME, probs = 0.8) ~ 'UH',
      HHINCOME > quantile(HHINCOME, probs = 0.8) ~ 'T20',
      TRUE ~ NA_character_),

  earner_type = case_when(
    HHINCOME == INCTOT ~ 'single_earner',
    HHINCOME != INCTOT ~ 'multi_earner',
    HHINCOME == 0 ~ 'no_earnings')
)


```


For each category that we've come up with, we want to summarize the data by year, gender, the housing characteristics (like are they a homeowner or a renter?), and the other characteristics (like what is their income level?)


year | gender | homeownership | cost_burden | mother | head_of_household

``` {r}
#Louisville 2019 data

lville_2019 <- census_microdata081122 %>% 
  filter(year == '2019')

```

#Harrison uses to create percentiles
#Useful for finding medians
```{r, eval = FALSE}
test <- lville_2019 %>%
  mutate(
    HHINCOME = replace(HHINCOME, HHINCOME == 9999999, NA_real_)) %>%
  summarize(
    LH = Hmisc::wtd.quantile(HHINCOME, weights = HHWT, probs = 0.4),
    UH = Hmisc::wtd.quantile(HHINCOME, weights = HHWT, probs = 0.8))

#
```

```{r educ x OWN_AND_CB, eval=FALSE}
#1.Male vs Female
#sex_breakdown <- 
lville_2019 %>%
  group_by(sex) %>%
  summarize(n=sum(HHWT, na.rm = TRUE)) %>%
  mutate(total = sum(n),rate = n/sum(n)
  )
  
```


```{r, eval=FALSE}

#2.Earner  breakdown 
#(single female, vs single male, vs multi earner) ->need to manipulate to reach desired metric

#old code
#earner_breakdown <- 
lville_2019 %>%
  group_by(earner_type, sex) %>%
  summarize(n=sum(HHWT, na.rm = TRUE)) %>%
  mutate(total = sum(n),rate = n/sum(n)
  )

```

```{r, eval = FALSE}
survey_by_demog(lville_2019, 
                'earner_type',
                )

```

```{r, eval = FALSE}

##3.Household types by sex

#old code
hh_sex <- lville_2019 %>%
  group_by(sex, hh_type) %>%
  summarize(n=sum(HHWT, na.rm = TRUE)) %>%
  mutate(total = sum(n),rate = n/sum(n)
  )

```

```{r, eval = FALSE}
##4.Education by sex

#old code
edu_sex <- lville_2019 %>%
  group_by(educ, sex) %>%
  summarize(n=sum(HHWT, na.rm = TRUE)) %>%
  mutate(total = sum(n),percent = n/sum(n)
  )
```

```{r, eval = FALSE}
#plot
ggplot(edu_sex,
       aes( x = factor(educ, level = c('grad','bach','assoc','some_col','hs','no_hs')) ,
           y = percent,
           fill = sex)) +
  geom_bar(position="dodge", stat="identity") + 
          scale_y_continuous(labels = scales::percent)
```


```{r, eval = FALSE}

#survey function...how is this plotted?
survey_by_demog(lville_2019, 
                'educ',
                )
```

```{r, eval = FALSE}
## All 5a - 5c is old code..see survey function at end of chuck
## 5a. Income bucks representation for women
inc_breakdown_female <- lville_2019 %>% 
  filter(sex == 'female')%>%
  group_by(income_group) %>%
  summarize(n=sum(HHWT, na.rm = TRUE)) %>%
  mutate(total = sum(n),rate = n/sum(n)
  )
```


```{r, eval = FALSE}
## 5b. Women single earner breakdown
inc_breakdown_female_single <- lville_2019 %>% 
  filter(sex == 'female' & earner_type == 'single_earner')%>%
  group_by(income_group) %>%
  summarize(n=sum(HHWT, na.rm = TRUE)) %>%
  mutate(total = sum(n),rate = n/sum(n)
  )
```


```{r, eval = FALSE}
## 5c. Male Single earner breakdown
lville_2019 %>% 
  filter(sex == 'male' & earner_type == 'single_earner')%>%
  group_by(income_group) %>%
  summarize(n=sum(HHWT, na.rm = TRUE)) %>%
  mutate(total = sum(n),rate = n/sum(n)
  )
```


```{r, eval = FALSE}
survey_by_demog(lville_2019, 
                'income_group',
                )

```


```{r, eval = FALSE}
## 6a. single earner female vs single earner male vs multi eaners group by hh_type
lville_2019 %>% 
  filter(earner_type == 'multi_earner') %>%
  group_by(hh_type) %>%
  summarize(n=sum(HHWT, na.rm = TRUE)) %>%
  mutate(total = sum(n),rate = n/sum(n)
  )
```


```{r, eval = FALSE}
survey_by_demog(lville_2019, 
                'earner_type',
                )
```

```{r, eval = FALSE}
## 6b -> single male/female household type

#old code
single_fem_male_earner_hh_breakdown <- lville_2019 %>% 
  filter(earner_type == 'single_earner') %>%
  group_by(sex, hh_type) %>%
  summarize(n=sum(HHWT, na.rm = TRUE)) %>%
  mutate(total = sum(n),rate = n/sum(n)
  )
```


```{r, eval = FALSE}
single_fem_male_earner_hh_survey <- lville_2019 %>% 
  filter(earner_type == 'single_earner') %>%
  survey_by_demog(lville_2019, 
                'income_group',
              )

```


```{r, eval = FALSE}
## 6c.single earner female vs single earner male vs multi eaners group by income_group
multi_vs_single_income <- lville_2019 %>%
  mutate(spec_earn_type = case_when(
    earner_type == 'multi_earner' ~ 'multi',
    earner_type == 'single_earner' & sex == 'female' ~ 'single_female_earner',
    earner_type == 'single_earner' & sex == 'male' ~ 'single_male_earner')) %>%
  
  group_by(spec_earn_type, income_group) %>%
  summarize(n=sum(HHWT, na.rm = TRUE)) %>%
  mutate(total = sum(n),percent = n/sum(n)
  )
```


```{r, eval = FALSE}
# 6c. plot
ggplot(multi_vs_single_income,
       aes(x = spec_earn_type,
           y = percent,
           fill = income_group)) +
  geom_bar(position="dodge", stat="identity") + 
          scale_y_continuous(labels = scales::percent)
```


```{r, eval = FALSE}
# 6d. Multi earner breakdown by income group
multi_eaner_inc_breakdown <- lville_2019 %>% 
  filter(earner_type == 'multi_earner') %>%
  group_by(income_group) %>%
  summarize(n=sum(HHWT, na.rm = TRUE)) %>%
  mutate(total = sum(n),rate = n/sum(n)
  )

```


```{r, eval = FALSE}
## 6e. single male/female income
single_earner_inc_breakdown <- lville_2019 %>% 
  filter(earner_type == 'single_earner') %>%
  group_by(sex, income_group) %>%
  summarize(n=sum(HHWT, na.rm = TRUE)) %>%
  mutate(total = sum(n), rate = n/sum(n)
  )
```


```{r, eval=FALSE}
#Is homeownership of black women going up or down?
#homeownership: Values are TRUE or FALSE
#Isolate louisville data for years 2017,2018,2019 as test
#should this be filtered to only include single earners? (do my filters ensure female head of house)

#year %in% c(2017, 2018, 2019)
#year %in% 2017:2019
census_microdata081122 %>% 
  
  filter(year == 2019| 
        year == 2018 | 
        year == 2017,
        race == 'black',
        sex == 'female') %>%
  
  group_by(year, homeownership) %>%
  
  summarize(n=sum(HHWT, na.rm = TRUE)) %>%
  
  mutate(
        Freq = n/sum(n))
```


```{r, eval=FALSE}
survey_by_demog(census_microdata081122 %>% 
                  filter(sex == 'female',
                         ), 
                'homeownership',
                )
```

```{r}
#plot above data when format is decided
#probably use a bar chart


```

```{r,eval=FALSE}

### Household Structure
#break data down by (1) marital status, (2) presence and number of children, and perhaps whether the (3) household is a three-generation household or includes other relatives.

census_microdata %>% 
  recode(MARST, 1='Married, with Spouse', 2 = 'Married, without Spouse',  3='Seperated',4='Divocred', 5='Widowed', 6= 'Single', .default = NA_character_),

  recode(MULTGEN, 0 = NA_character_, 1 = 'one_gen', 2 = 'two_gen', 3 = 'three_gen_min', .default = NA_character_))

# census_microdata %>% group_by(household_type) %>% summarize(n = n()) ### can also use this for multigen. just count obversations

## Use NCHILD for number of children: Coded 0-9 with 9 indicating at least 9 children



```

```{r, include = FALSE}
#Finding income ranges
library(viridis)
library(forcats)
library(hrbrthemes)

cut_95 = quantile(lville_2019$HHINCOME, probs = 0.95)

```


```{r}
#Base function to see year by year comparison
#looks at income across years. Only parameter is data frame that is filtered when function is called
func_plt_hist_base <- function(data) {
  
  p <- data %>% 
  mutate(year = factor(year)) %>%
  mutate(text = fct_reorder(year, HHINCOME)) %>%
  
  ggplot( aes(x=HHINCOME, color=text, fill=text, weight = HHWT)) +
    geom_histogram(alpha=0.5, binwidth = 10000) +
    scale_fill_viridis(discrete=TRUE) +
    scale_color_viridis(discrete=TRUE) +
    theme_ipsum() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    ) +
    xlab("Household Income") +
    ylab("Count") +
    facet_wrap(~text)
    
  return (p)
}
```

```{r}

#Updated version of above function used to compare groups rather than same group over time
func_plt_hist_updated <- function(data, var) {
  
  data$group <- data[[var]]
  # replace group param with var when fixing later
  
  p <- data %>% 
  mutate(y = factor(group)) %>% #this might not be necessary
  mutate(text = fct_reorder(y, HHINCOME)) %>%

  
  ggplot( aes(x=HHINCOME, color=text, fill=text, weight = HHWT)) +
    geom_histogram(alpha=0.5, binwidth = 10000) +
    geom_vline(xintercept = cut_95, col = "red") +
    scale_fill_viridis(discrete=TRUE) +
    scale_color_viridis(discrete=TRUE) +
    theme_ipsum() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    ) +
    xlab("Household Income") +
    ylab("Count") +
    facet_wrap(~text)
    
  return (p)
}
```

```{r}
#Overlayed histogram
func_plt_hist_overlay <- function(data, var) {

  data$group <- data[[var]]

  p <- data %>% ggplot( aes(x=HHINCOME, fill=group, weight = HHWT)) +
    geom_histogram( color="#e9ecef", alpha=0.5, position = 'identity', binwidth = 10000 ) +
    geom_vline(xintercept = cut_95, col = "red") +
    scale_fill_viridis(discrete=TRUE) +
    scale_color_viridis(discrete=TRUE) +
    theme_ipsum() +
    labs(fill="")
  
  return (p)
  
}
  
```

```{r}
#Overlay density plot
func_plt_dens_overlay <- function(data, var) {

  data$group <- data[[var]]

  q <- data %>% ggplot( aes(x=HHINCOME, fill=group, weight = HHWT)) +
    geom_density( color="#e9ecef", alpha=0.5, position = 'identity', binwidth = 10000 ) +
    geom_vline(xintercept = cut_95, col = "red") +
    scale_fill_viridis(discrete=TRUE) +
    scale_color_viridis(discrete=TRUE) +
    theme_ipsum() +
    labs(fill="")

  return (q)

}
  
```

```{r, eval = FALSE}
#Compare 2019, 2018, 2017: uses base hist function
census_microdata081122 %>% 
      filter(year == 2019| 
        year == 2018 | 
        year == 2017) %>%
  func_plt_hist_base()
```

```{r, eval = FALSE}
#Black, Female, 2017 to 2019: uses base hist function
census_microdata081122 %>%
  filter(year == 2019| 
        year == 2018 | 
        year == 2017,
        race == 'black',
        sex == 'female') %>%
  func_plt_hist_base()

```


```{r}
#Male vs. Female income
lville_2019 %>%
  func_plt_hist_updated( "sex")
```

```{r}
#Male vs. Female income truncated
lville_2019 %>%
  filter(HHINCOME <= cut_95) %>%
  func_plt_hist_updated( "sex")
```

```{r}
#Male vs. female income truncated, overlay - unclear to look at (try different colors first before diff type of viz)
lville_2019 %>% 
  filter(HHINCOME <= cut_95) %>%
        func_plt_hist_overlay( "sex")
```

```{r}
#Single male vs. single female income, truncated
lville_2019 %>% 
  filter(earner_type == 'single_earner',
      HHINCOME <= cut_95) %>%
        func_plt_hist_updated( "sex")
```

```{r}
#Single male vs. single female income, truncated, overlay-> might incorporate 95th percentile for each group (i.e. single male 95th - do this outside of r)
lville_2019 %>% 
  filter(earner_type == 'single_earner',
      HHINCOME <= cut_95) %>%
        func_plt_hist_overlay( "sex")
```

```{r}
#Female home-owners vs. female non-homeowners income
lville_2019 %>%
  filter(sex == 'female') %>%
  mutate(homeownership = replace(homeownership, homeownership == T, 'Homeowner'),
         homeownership = replace(homeownership, homeownership == F, 'Renter')) %>%
    func_plt_hist_updated( "homeownership")

```

```{r}
#Female home-owners vs. female non-homeowners income, overlay
lville_2019 %>%
  filter(sex == 'female') %>%
  mutate(homeownership = replace(homeownership, homeownership == T, 'Homeowner'),
         homeownership = replace(homeownership, homeownership == F, 'Non homeowner')) %>%
    func_plt_hist_overlay( "homeownership")

```

```{r}
#Female, Single home-owners vs. female, single, non-homeowners income
lville_2019 %>%
  filter(sex == 'female',
         earner_type == 'single_earner') %>%
  mutate(homeownership = replace(homeownership, homeownership == T, 'Homeowner'),
         homeownership = replace(homeownership, homeownership == F, 'Non homeowner')) %>%
    func_plt_hist_updated( "homeownership")

```

```{r}
#race by income overlay, truncated - tested with overlayed density plot...right path but could display info better...ideally can make this graph interactive so ppl can select a specfic group and then can also select specific percentiles...create df using suvery by demog function

census_microdata081122 %>% 
  filter(year %in% 2017:2019,
    sex == 'female',
         HHINCOME <= cut_95) %>%
        func_plt_dens_overlay( "race")

```

```{r, eval = FALSE}

###come back to this...dont ignore it
df <- census_microdata081122 %>% 
  filter(year %in% 2017:2019,
    sex == 'female') 

survey_by_demog(df, type = 'mean', "HHINCOME")

```


#### Moving into Bar charts rather than histograms

```{r, eval = FALSE}
lville_2019 %>%
  filter(sex == 'female') %>%
  mutate(homeownership = replace(homeownership, homeownership == T, 'Homeowner'),
         homeownership = replace(homeownership, homeownership == F, 'Non homeowner')) %>%

  group_by(race, homeownership) %>%
  summarize(n=sum(HHWT, na.rm = TRUE)) %>%
  mutate(total = sum(n),percent = n/sum(n)
  ) %>% 

ggplot( aes(x = homeownership,
           y = percent,
           fill = race)) +
  geom_bar(position="dodge", stat="identity") +
          scale_y_continuous(labels = scales::percent)
```



```{r, eval=FALSE}
# Housing
x<-lville_2019 %>%
  
  mutate(homeownership = replace(homeownership, homeownership == T, 'Homeowner'),
         homeownership = replace(homeownership, homeownership == F, 'Non homeowner'))
  
p<-survey_by_demog(x, weight_var = "HHWT", 'homeownership',)
  
ggplot(p, aes(x=race, y=homeownership, fill=sex)) + #can HHWT be incorporated or is it unnecessary?
geom_bar(stat="identity", position=position_dodge())



```

```{r, eval= FALSE}
survey_by_demog(lville_2019, 
                weight_var = "HHWT", 'homeownership')%>% filter(var_type == 'percent') %>%
  ggplot( aes(x=race, y=homeownership, fill=sex)) + 
geom_bar(stat="identity", position=position_dodge())
```


```{r, eval = FALSE}
p <- survey_by_demog(lville_2019, 
                weight_var = "HHWT", 'homeownership')

q <- p %>% filter(var_type == 'percent')

ggplot(q, aes(x=race, y=homeownership, fill=sex)) + 
geom_bar(stat="identity", position=position_dodge())

```

```{r, eval = FALSE}
# Housing type, female single vs female multiple

lville_2019 %>% 
  
  filter(sex == 'female') %>%
  
ggplot( aes(x=homeownership, y=HHWT, fill=earner_type, weights = HHWT)) +
geom_bar(stat="identity", position=position_dodge())



## 6c.single earner female vs single earner male vs multi eaners group by income_group
# multi_vs_single_income <- lville_2019 %>%
#   mutate(spec_earn_type = case_when(
#     earner_type == 'multi_earner' ~ 'multi',
#     earner_type == 'single_earner' & sex == 'female' ~ 'single_female_earner',
#     earner_type == 'single_earner' & sex == 'male' ~ 'single_male_earner')) %>%
#   
#   group_by(spec_earn_type, income_group) %>%
#   summarize(n=sum(HHWT, na.rm = TRUE)) %>%
#   mutate(total = sum(n),percent = n/sum(n)
#   )

# ggplot(multi_vs_single_income,
#        aes(x = spec_earn_type,
#            y = percent,
#            fill = income_group)) +
#   geom_bar(position="dodge", stat="identity") + 
#           scale_y_continuous(labels = scales::percent)
```


_________________________________________________________________________________________________________________
_________________________________________________________________________________________________________________
_________________________________________________________________________________________________________________

```{r, eval=FALSE}
#histogram: Housing type in lville in 2019
func_plt_hist_updated(lville_2019, lville_2019$hh_type)

```

```{r, eval = FALSE}
#histogram: female income by housing type

df <-
  lville_2019 %>% 
  filter(sex == 'female',
         HHINCOME <= cut_95) 

func_plt_hist_updated(df, df$hh_type)
```

```{r, eval=FALSE}
#histogram: male income by housing type

df <-
  lville_2019 %>% 
  filter(sex == 'male',
         HHINCOME <= cut_95)

func_plt_hist_updated(df, df$hh_type)
```

```{r, eval=FALSE}
#histogram: female single earner income by housing type
df <-
  lville_2019 %>% 
  filter(sex == 'female',
         earner_type == 'single_earner',
         HHINCOME <= cut_95) 

func_plt_hist_updated(df, df$hh_type) #look at degree type here as well
```


```{r, eval=FALSE}
#histogram: female single earner income by housing type
df <-
  lville_2019 %>% 
  filter(sex == 'male',
         earner_type == 'single_earner',
         HHINCOME <= cut_95) 

func_plt_hist_updated(df, df$hh_type)
```


