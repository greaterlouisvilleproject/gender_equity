---
title: "Gender Equity Dashboard"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      dev.args=list(bg="transparent"), fig.width=15, fig.height=12)

library(glptools)
glp_load_packages(TRUE)
library(arrow)
library(viridis)
library(forcats)
library(hrbrthemes)
library(glpdata)


showtext_auto()
font_add("Museo Sans", "MuseoSans_300.otf")

```



```{r, include=FALSE}
#Overlayed histogram
func_plt_hist_overlay <- function(data, var) {

  data$group <- data[[var]]

  possible_colors <- c("#0E4A99", "#F58021", "#00A9B7", "#800055", "#356E39", "#CFB94C", "#7E9C80")
  number_I_need = length(unique(data$group))
  these_colors <- possible_colors[1:number_I_need]

  p <- data %>% ggplot( aes(x=HHINCOME, fill=group, color = group, weight = HHWT)) +
    geom_histogram(alpha=0.5, position = 'identity', binwidth = 10000) +
    scale_fill_manual(values = these_colors) +
    scale_color_manual(values = these_colors) +

    labs(fill="") +
    xlab("Household Income") +
    ylab("Percentage") 
    
  
  return (p)
  
}

glp_graph_theme <- theme_bw(
    base_size = 8,
    base_family = "Museo Sans")

glp_graph_theme <- glp_graph_theme +
  theme(
    legend.title     = element_blank(),
    legend.position  = "top",
    legend.margin    = margin(t = 10, unit = "pt"),
    legend.spacing.x = unit(30, "pt"),
    legend.text      = element_text(size = 40,
                                    margin = margin(b = 15, t = 15, unit = "pt")),

    axis.text    = element_text(size = 50),
    axis.title   = element_text(size = 60),
    axis.title.x = element_text(margin = margin(t = 15, unit = "pt")),
    axis.title.y = element_text(margin = margin(r = 15, unit = "pt")),

    plot.title = element_text(size = 90,
                              hjust = .5,
                              margin = margin(b = 25, unit = "pt")),

    plot.caption = element_text(size = 40,
                                lineheight = 0.5)) +
    theme(
      panel.background = element_rect(fill = "transparent", color = NA), # bg of the panel
      plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
      legend.background = element_rect(fill = "transparent", color = "transparent"), # get rid of legend bg
      legend.box.background = element_rect(fill = "transparent", color = "transparent"), # get rid of legend panel bg
      legend.key = element_rect(fill = "transparent",colour = NA)
    )
  
      # theme(plot.subtitle = element_text(hjust = 0.5, size = 50)) +
      # labs(subtitle = subtitle_text)

```

```{r prep_data, eval=FALSE, include=FALSE}
#Skip
# Harrison
#census_data <- read_feather("../../glpdata/data-raw/microdata/acs_micro_repwts.feather")

#Josh
#census_data <- read_feather("/Users/joshmarkwell/Desktop/Professional/GLP/projects/gender_equity/raw_data/acs_micro_repwts.feather")


census_data %<>%
  filter(FIPS == "21111")

write_feather(census_data, "raw_data/census_data.feather")


save(population_tract, file = "raw_data/tract_population.RData")

```

# Housing data

In this first chunk, let's read in the Census microdata. Here is some example code on how to read in the data, create new variables to categorize the rows of data into groups, and then summarize the data to create information about Louisville.

Our goal is to create variables for gender, age group, whether someone is a mother, whether someone is married, their level of education, their income, whether they are the head of household, and the number of children they have.



```{r read in new data, eval=FALSE, include=FALSE}
#Skip - only use if changing data to include

#acs_micro_8_11_22 <- read_feather("raw_data/acs_micro_FIPS_repwts_8_11_22.feather") 

census_data %<>%
  filter(FIPS == "21111" | FIPS == '37081')


write_feather(census_data, "raw_data/census_data_8_11_22.feather")

```


```{r explore new data, include=FALSE}
#Start
#File for use below
census_microdata081122 <- read_feather("raw_data/census_data_8_11_22.feather") 

```
This code chunk will identify which households are homeowners vs. renters (in the homeownership variable) and which households are cost-burdened, meaning they pay more thatn 30% of their income toward rent or a mortgage (in the cost_burden variable).

There are also variables for severe cost burden (households that pay more than half of their income towards housing) and households with severe housing problems (lacking a kitchen, adequate plumbing, or an ample number of rooms for the number of people living there).


```{r clean data, include= FALSE}
# To classify the housing data into homeowners, renters, cost-bu
#also create income brackets, earner types

census_microdata081122 %<>%
  group_by(year, SERIAL) %>%
  mutate(hh_members = n()) %>%
  ungroup() %>%
  filter(PERNUM == 1) %>%
  mutate(
    OWNCOST  = replace(OWNCOST, OWNCOST == 99999, NA),
    HHINCOME = replace(HHINCOME, HHINCOME == 99999, NA),
    OWNERSHP = replace(OWNERSHP, OWNERSHP == 0, NA),
    RENTGRS  = replace(RENTGRS, RENTGRS == 0 & OWNERSHP == 1, NA),

    homeownership = if_else(OWNERSHP == 1, T, F),

    hcost = if_else(homeownership == 1, OWNCOST, RENTGRS),
    cost_burden = if_else(hcost * 12 / HHINCOME > 0.3, T, F),
    severe_cost_burden = if_else(hcost * 12 / HHINCOME > 0.5, 1, 0),

    hh_type = case_when(
      homeownership  & !cost_burden ~ "noncb_homeowner",
      homeownership  & cost_burden  ~ "cb_homeowner",
      !homeownership & !cost_burden ~ "noncb_renter",
      !homeownership & cost_burden  ~ "cb_renter",
      TRUE ~ NA_character_),
    
    KITCHEN  = replace(KITCHEN, KITCHEN == 0, NA),
    ROOMS    = replace(ROOMS, ROOMS == 0, NA),
    PLUMBING = replace(PLUMBING, PLUMBING == 0, NA),

    severe_housing_problems = if_else(
      KITCHEN == 1 | PLUMBING == 10 | hh_members / ROOMS > 1 | severe_cost_burden, T, F),
    
#income brackets based on HHINCOME
  #LH-Lower half -> lower40% 
  #UH-Upper Half -> 40th to 80th 
  #T20 -> top 20th percentile

    
    income_group = case_when(
      HHINCOME <= quantile(HHINCOME, probs = 0.4) ~ 'LH',
      HHINCOME <= quantile(HHINCOME, probs = 0.8) ~ 'UH',
      HHINCOME > quantile(HHINCOME, probs = 0.8) ~ 'T20',
      TRUE ~ NA_character_),

  earner_type = case_when(
    HHINCOME == INCTOT ~ 'single_earner',
    HHINCOME != INCTOT ~ 'multi_earner',
    HHINCOME == 0 ~ 'no_earnings'),

  kd_pres = if_else(NCHILD > 0, "kids", "no_kids"), 

    male_fem_mult_earn = case_when(
      sex == 'female' & earner_type == 'single_earner' ~ 'single_fem_earner',
      sex == 'male' & earner_type == 'single_earner' ~ 'single_male_earner',
      earner_type == 'multi_earner' ~ 'multiple_earner') ,

    age_group = case_when(
      age %in% 15:19 ~ NA_character_, age %in% 20:29 ~ "20 - 29", 
      age %in%  30:39 ~ "30 - 39",  age %in% 40:49 ~ "40 - 49",  age %in% 50:59 ~ "50 - 59",  age %in% 60:69 ~ "60 - 69", age %in% 70:79 ~ "70 - 79", age >= 80 ~ "80 + ") 
)

census_microdata081122 %<>% filter(!is.na(age_group))
  
```

``` {r louisville 2019 data, include = FALSE}

lville_2019 <- census_microdata081122 %>% 
  filter(FIPS == '21111',
         year == '2019')

```

```{r Saves Survey By Demographic Data Frames, eval=FALSE}

## SKIP ##
H_gen_trend<-survey_by_demog(census_microdata081122, weight_var = "HHWT", 'homeownership')

H_singFem_rank <- census_microdata081122 %>%
  filter(
    year == '2019',
    earner_type == 'single_earner') %>%
  survey_by_demog('homeownership', weight_var = "HHWT") %>%
  filter(
    sex == 'total',
    race == 'total',
    var_type == 'percent')


H_sinFem_kids <-census_microdata081122 %>%
  filter(
    year == '2019',
    earner_type == 'single_earner',
    NCHILD > 0) %>%
  survey_by_demog('homeownership', weight_var = "HHWT") %>%
  filter(
    sex == 'total',
    race == 'total',
    var_type == 'percent')


H_s_Femkids_trend <- census_microdata081122 %>%
                    filter(earner_type == 'single_earner') %>%
  survey_by_demog( weight_var = "HHWT", 'homeownership', other_grouping_vars = c("kd_pres"))

H_Fem_race <- census_microdata081122 %>%
  filter(sex == 'female') %>%
  survey_by_demog( weight_var = "HHWT", 'homeownership')

I_CB_earn_trend <- survey_by_demog(census_microdata081122, weight_var = "HHWT", 'cost_burden', other_grouping_vars = c('male_fem_mult_earn'))

save(H_gen_trend, H_singFem_rank, H_sinFem_kids, H_s_Femkids_trend, H_Fem_race, I_CB_earn_trend, lville_2019,
     file = "clean_svybydemog_data.RData")



```

```{r}
load("clean_svybydemog_data.RData")
```


#Waffle Chart
```{r Harrison, eval=FALSE, include=FALSE}

waffle_data <- survey_by_demog(lville_2019, "hh_type", other_grouping_vars = c("kd_pres", "earner_type"))

gender <- waffle_data %>%
  filter(
    race == "total",
    sex != "total",
    var_type == "population") %>%
  group_by(sex) %>%
  summarize(n = sum(cb_homeowner), .groups = "drop") %>%
  mutate(pct = n / sum(n) * 100)

earn_type <- waffle_data %>%
  filter(
    race == "total",
    sex != "total",
    var_type == "population") %>%
  group_by(sex, earner_type)  %>%
  summarize(n = sum(cb_homeowner), .groups = "drop") %>%
  mutate(pct = n / sum(n) * 100)
  
demog_data <- data.frame(
  row_num = rep(1:10, each = 10),
  col_num = rep(10:1, 10),
  gender = c(rep("male", 52), rep("female", 48)),
  earn_type = c(rep("multi_earn", 28), rep("single_earn", 20), rep("multi_earn", 29), rep("single_earn", 23)))

g1 <- ggplot(demog_data, aes(x = row_num, y = col_num, color = gender)) + 
  geom_point(size = 10) 

g2 <- ggplot(demog_data, aes(x = row_num, y = col_num, color = earn_type)) + 
  geom_point(size = 10) 


library(shiny)
library(scrollytell)
library(shinyjs)
library(ggvis)
library(plotly)

ui <- fluidPage(

    # Application title
    titlePanel("Scrolly Telling"),
    sidebarLayout( sidebarPanel("Hi"),
    tabsetPanel(
      id="tab",
      tabPanel("bla",
            fluidRow(h2("Hi")),
            fluidRow(
        scrolly_container("scr"
             , scrolly_graph( textOutput("section"),
                              plotOutput("distPlot")

                            )
             , scrolly_sections(
                scrolly_section( id = "green",
                     sliderInput("bins", "Number of bins:", min = 1, max = 50, value = 30)
                ),
                scrolly_section(id = "red",
                    h3("Title"),
                    p("dit is een paragraaf, die de grafiek rood maakt")
                ),
                scrolly_section(id = "blue","Blauw"),
                scrolly_section(id = "pink","Rose"),
                scrolly_section(id = "purple","Paars"),
                scrolly_section(id = "orange","Oranje boven!")
             )
        )
            ))
      )
    ),
    div("Footer")
)

# Define server logic required to draw a histogram
server <- function(input, output) {

    output$distPlot <- renderPlot({
        # generate bins based on input$bins from ui.R
        x    <- faithful[, 2]
        bins <- seq(min(x), max(x), length.out = input$bins + 1)
        col <- input$scr
        # draw the histogram with the specified number of bins
        hist(x, breaks = bins, col = col, border = 'white')
    })

    output$scr <- renderScrollytell({scrollytell()})
    output$section <- renderText(paste0("Section: ", input$scr))

    observe({cat("section:", input$scr, "\n")})
}

shinyApp(ui, server, options = list(height = 500))
```


# Homeownership

```{r Trend in Homeownership by Gender}

#H_gen_trend<-survey_by_demog(census_microdata081122, weight_var = "HHWT", 'homeownership')

H_gen_trend %<>%
  filter(
    var_type == 'percent',
    race == 'total',
    sex != 'total')

trend(H_gen_trend, 
      homeownership,
      plot_title = "Homeownership by Year", 
      cat = 'sex', 
      y_title = 'Percent',
      caption_text = 
      "Source Greater Louisville Project
       Data from GLP analysis of ACS microdata from IPUMS-USA")

```

```{r Ranking Single Female Homeownership}

# H_singFem_rank <- census_microdata081122 %>%
#   filter(
#     year == '2019',
#     earner_type == 'single_earner') %>%
#   survey_by_demog('homeownership', weight_var = "HHWT") %>%
#   filter(
#     sex == 'total',
#     race == 'total',
#     var_type == 'percent')

ranking(H_singFem_rank, 'homeownership')

```

```{r Ranking Single Female with Kids Homeownership}

# H_sinFem_kids <-census_microdata081122 %>%
#   filter(
#     year == '2019',
#     earner_type == 'single_earner',
#     NCHILD > 0) %>%
#   survey_by_demog('homeownership', weight_var = "HHWT") %>%
#   filter(
#     sex == 'total',
#     race == 'total',
#     var_type == 'percent')

ranking(H_sinFem_kids, 'homeownership')

```

```{r Trend in Homeownership by for Single Females with vs. without Kids}

# H_s_Femkids_trend <- census_microdata081122 %>%
#                     filter(earner_type == 'single_earner') %>%
#   survey_by_demog( weight_var = "HHWT", 'homeownership', other_grouping_vars = c("kd_pres"))
  
H_s_Femkids_trend %<>%
  filter(
    var_type == 'percent',
    race == 'total',
    sex == "female") %>%
  pivot_wider(names_from = 'kd_pres', values_from = 'homeownership') %>%
  select(-sex)



trend(H_s_Femkids_trend, 
      kids:no_kids,
      rollmean = 3,
      plot_title = "Female Homeownership by Presence of Children", 
      cat = c("Children" = "kids", "No Children" = "no_kids"), 
      y_title = 'Percent',
      caption_text = 
      "Source Greater Louisville Project
       Data from GLP analysis of ACS microdata from IPUMS-USA")

```

```{r Trend in Female Homeownership by Race}

#H_Fem_race <- survey_by_demog(census_microdata081122 ,weight_var = "HHWT", 'homeownership')

# H_Fem_race <- census_microdata081122 %>%
#   filter(sex == 'female') %>%
#   survey_by_demog( weight_var = "HHWT", 'homeownership')


H_Fem_race %<>%
  filter(
    var_type == 'percent',
    race != 'total',
    sex == 'total')

trend(H_Fem_race, 
      homeownership, 
      rollmean = 3,
      pctiles = F,
      plot_title = "Female With Kids Homeownership by Year", 
      cat = 'race', 
      y_title = 'Percent',
      caption_text = 
      "Source Greater Louisville Project
       Data from GLP analysis of ACS microdata from IPUMS-USA")

```



# Income

```{r, include = FALSE}
#Finding income ranges

#95th perc of income
cut_95 = quantile(lville_2019$HHINCOME, probs = 0.95)

```


```{r 2019 Louisville Men and Women Income Compared}

#################KEEP################

## create hist for each of the most three recent years -> just for verification...that there isnt anything weird
## if feeling funky, use gganimate to create a gif of histograms from 2000 to 2019

#TO DO:
# Change the x-axis to a dollar format (see trendline function in trendline_helpers.R) - done
# Label the x-axis on every $50,000? - done
# Let's use counts on the y-axis for the male and female graph - done?
# Format the y-axis with commas - done
# remove legend? - done

#p$HHINCOME %>% dollar(accuracy = 0.1, scale = .001, suffix = "k") 

p <- lville_2019 %>% 
  filter(HHINCOME <= cut_95,
         earner_type == "single_earner") %>%
  func_plt_hist_overlay( "sex")

p <- p + glp_graph_theme


p <- p + labs(
  title = "Male Single Earner vs Female Single Earner Dollars",
) + 
  ylab(" ") +
  
  guides(color = FALSE) + 
  
  facet_wrap(~sex, nrow = 2) 

p <- p + 
  
  theme( 
  #axis.ticks.x =  element_line(size = 50000),
  strip.text = element_blank()
  
  )  + 
  
scale_x_continuous(
  breaks = c(50000, 100000, 150000, 200000),
  label = c("$50k", "$100k", "$150k", "$200k")
) + 
  scale_y_continuous(labels = scales::comma)

p
```

```{r 2019 Louisville Single Female Income by Race}

# TO DO
# facet this into four panels
# Either check that the y-axis become independent to get more info around other groups OR change the data from counts to percentages


sing_fem_inc_race <- lville_2019 %>% 
  filter(
    sex == 'female',
    earner_type == 'single_earner',
    HHINCOME <= cut_95) %>%
  func_plt_hist_overlay( "race") 

sing_fem_inc_race <- sing_fem_inc_race + facet_wrap(~race, nrow = 2) 

sing_fem_inc_race <- sing_fem_inc_race + glp_graph_theme

sing_fem_inc_race <- sing_fem_inc_race + 
  labs(
  title = "Single Female Earner Income",
) + 
  ylab(" ") +
  
  guides(color = FALSE)

sing_fem_inc_race <- sing_fem_inc_race + 
  
  theme( 
  #axis.ticks.x =  element_line(size = 50000),
  strip.text = element_blank()
  
  )  + 
  
scale_x_continuous(
  breaks = c(50000, 150000),
  label = c("$50k", "$150k")
)


sing_fem_inc_race
```

```{r 2019 Louisville Cost of living Burden for Single Females - stacked histogram}

# TO DO
# see above for x and y axis to-dos
# Drop the legend title (see )


cost_burden_sf <- lville_2019 %>% 
  filter(
    sex == 'female',
    earner_type == 'single_earner',
    HHINCOME <= cut_95) %>%
  mutate(
    cost_burden = factor(cost_burden, 
                         levels = rev(c(TRUE, FALSE)), 
                         labels = rev(c("Cost Burdened", "Non Cost Burdened")), 
                         ordered = TRUE))

cost_burden_sf_plot <- ggplot(cost_burden_sf, 
       aes(x = HHINCOME, fill = cost_burden, weights = HHWT), 
       color="#00A9B7", 
       alpha=0.5, 
       position = "stack", 
       binwidth = 10000) + 
geom_histogram()

cost_burden_sf_plot <- cost_burden_sf_plot + glp_graph_theme

cost_burden_sf_plot <- cost_burden_sf_plot + 
  labs(
  title = "Single Female Earner Cost Burden",
) + 
  ylab(" ") +
  xlab("Household Income") +
  
  guides(color = FALSE)

cost_burden_sf_plot <- cost_burden_sf_plot + 
  
  theme( 
  #axis.ticks.x =  element_line(size = 50000),
  strip.text = element_blank()
  
  )  + 
  
scale_x_continuous(
  breaks = c(50000, 100000, 150000, 200000),
  label = c("$50k", "$100k", "$150k", "$200k")
) + 
  scale_y_continuous(labels = scales::comma)

cost_burden_sf_plot
```

```{r Cost-burdened by earner type Trend }

#I_CB_earn_trend <- survey_by_demog(census_microdata081122, weight_var = "HHWT", 'cost_burden', other_grouping_vars = c('earner_type'), breakdowns = "sex")

# I_CB_earn_trend <- survey_by_demog(census_microdata081122, weight_var = "HHWT", 'cost_burden', other_grouping_vars = c('male_fem_mult_earn'))

I_CB_earn_trend %<>%
  filter(
    var_type == 'percent',
    race == 'total',
    sex == 'total') %>%
  select( -c(sex,race)) %>%
  pivot_wider(names_from = "male_fem_mult_earn", values_from = "cost_burden")
  

trend(I_CB_earn_trend, 
      multiple_earner:single_fem_earner:single_male_earner, 
      plot_title = "Cost Burden by Earner Type",
      cat = c("Multiple Earners" = "multiple_earner", "Single Female Earner" = "single_fem_earner", "Single Male Earner" = "single_male_earner"),
      y_title = 'Percent',
      caption_text = 
      "Source Greater Louisville Project
       Data from GLP analysis of ACS microdata from IPUMS-USA")



```

```{r Median Income for Earning Group by Age}

I_median_earn_age <- lville_2019 %>%
  group_by(age_group, male_fem_mult_earn) %>%
  summarize(Med=median(HHINCOME)) 

ggplot(I_median_earn_age, 
       aes(x=age_group, y=Med, fill = male_fem_mult_earn)) + 
  geom_bar(stat="identity", position='dodge')

```

```{r Variation of Graph Above}

#Do not use
ggplot(I_median_earn_age, 
       aes(x=age_group, y=Med, fill = male_fem_mult_earn)) + 
  geom_bar(stat="identity", position='fill')

```


# Education

```{r Education for Single Male Vs. Single Female}

E_singM_singF <- lville_2019 %>% 
  filter(earner_type == 'single_earner') %>%
  group_by(sex, educ) %>%
  summarize(n=sum(HHWT, na.rm = TRUE)) %>%
  mutate(
    total = sum(n),
    rate = n/sum(n)*100,
    educ = factor(educ, 
                  levels = rev(c("no_hs", "hs", "some_col", "assoc", "bach","grad")), 
                  ordered = TRUE))

ggplot(E_singM_singF, 
       aes(x=sex, y=rate, fill=educ)) + 
  geom_bar(stat="identity", position='fill')

```

```{r, Education of Single Female by race}

E_singF_race <- lville_2019 %>% 
  filter(
    sex == 'female',
    earner_type == 'single_earner') %>%
  group_by(race, educ) %>%
  summarize(n=sum(HHWT, na.rm = TRUE)) %>%
  mutate(
    total = sum(n),
    rate = n/sum(n)*100,
    educ = factor(educ, 
                  levels = rev(c("no_hs", "hs", "some_col", "assoc", "bach","grad")), 
                  ordered = TRUE))

ggplot(E_singF_race, aes(x=race, y=rate, fill=educ)) + 
geom_bar(stat="identity", position='fill')

```


# Household Age
```{r Cost Burdened Status by Age}

#Stacked histogram

cost_burden_age_sf <- census_microdata081122 %>% 
    filter(year %in% 2010:2019) %>%
  mutate(
    cost_burden = factor(cost_burden, 
                         levels = rev(c(TRUE, FALSE)), 
                         labels = rev(c("Cost Burdened", "Non Cost Burdened")), 
                         ordered = TRUE)
    )


ggplot(cost_burden_age_sf,
       aes(x=age_group, y=HHWT , fill=cost_burden),
        color="#00A9B7") +
geom_bar(stat="identity", position='fill')


```

```{r  Cost Burdened Stage by Age/Race}

ggplot(cost_burden_age_sf,
       aes(x=age_group, y=HHWT , fill=cost_burden),
        color="#00A9B7") +
geom_bar(stat="identity", position='fill')+
facet_wrap(~male_fem_mult_earn)

```

# Earner Types Over Time
```{r Proportion of Earner Types over time}

earner_trend <- census_microdata081122 %>%
  
  mutate(
    male_fem_mult_earn = case_when(
      sex == 'female' & earner_type == 'single_earner' ~ 'single_fem_earner',
      sex == 'male' & earner_type == 'single_earner' ~ 'single_male_earner',
      earner_type == 'multi_earner' ~ 'multiple_earner')
  ) %>% 
  group_by(year, male_fem_mult_earn) %>%
  summarize(n=sum(HHWT, na.rm = TRUE)) %>%
  mutate(
    total = sum(n),
    rate = n/sum(n)*100) 
  
ggplot(earner_trend, 
       aes(x=year, y=rate, fill=male_fem_mult_earn),
        color="#00A9B7") + 
geom_bar(stat="identity", position='fill')
```


# Mortgage Data
